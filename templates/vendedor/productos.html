{% extends 'base.html' %}
{% block content %}

<style>
/* ===== CONTEXTO GENERAL ===== */
.pos-wrapper {
    background: #f4f6f9;
    padding: 10px;
}

h2 {
    margin-bottom: 15px;
}

/* ===== FILTROS ===== */
.pos-filtros {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.pos-filtros input,
.pos-filtros select {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    flex: 1;
}

/* ===== LAYOUT ===== */
.pos-layout {
    display: grid;
    grid-template-columns: 3fr 1fr;
    gap: 20px;
}

/* ===== PRODUCTOS ===== */
.productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.producto {
    background: #fff;
    border-radius: 14px;
    padding: 15px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    transition: transform .15s ease, box-shadow .15s ease;
}

.producto:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.producto h4 {
    font-size: 16px;
    margin-bottom: 6px;
}

.producto p {
    font-size: 14px;
    color: #444;
    margin-bottom: 8px;
}

.producto input {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
}

.producto button {
    background: #4f46e5;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.producto button:hover {
    background: #4338ca;
}

/* ===== CARRITO ===== */
.carrito {
    background: white;
    border-radius: 14px;
    padding: 15px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    position: sticky;
    top: 20px;
    height: fit-content;
}

.carrito h3 {
    margin-bottom: 10px;
}

.carrito ul {
    list-style: none;
    padding: 0;
}

.carrito li {
    padding: 6px 0;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 900px) {
    .pos-layout {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="pos-wrapper">

<h2>ðŸ§¾ Productos</h2>

<!-- FILTROS -->
<div class="pos-filtros">
    <input id="buscador" placeholder="ðŸ” Buscar producto">

    <select id="proveedorFiltro">
        <option value="">Proveedor</option>
        {% for p in proveedores %}
        <option value="{{ p.id }}">{{ p.nombre }}</option>
        {% endfor %}
    </select>

    <input id="precioMax" type="number" placeholder="Precio mÃ¡x">
</div>

<div class="pos-layout">

<!-- PRODUCTOS -->
<div class="productos-grid">
{% for p in productos %}
<div class="producto"
     data-nombre="{{ p.nombre|lower }}"
     data-proveedor="{{ p.proveedor_id }}"
     data-precio="{{ p.precio|int }}">

    <h4>{{ p.nombre }}</h4>

    <p>
        <strong>
            ${{ "{:,}".format(p.precio|int).replace(",", ".") }}
        </strong>
    </p>

    <input type="number"
           min="1"
           value="1"
           class="cantidad"
           data-id="{{ p.id }}">

    <button onclick="agregar({{ p.id }})">
        âž• Agregar
    </button>
</div>
{% endfor %}

</div>

<!-- CARRITO -->
<div class="carrito">
    <h3>ðŸ›’ Carrito</h3>

    <ul id="carrito"></ul>

    <hr>

    <h2 id="totalCarrito">$0</h2>

    <button
        onclick="cobrar()"
        style="width:100%; margin-top:10px; background:#16a34a;">
        ðŸ’³ Cobrar
    </button>
</div>

</div>
</div>

<script>
const carrito = document.getElementById("carrito");
const totalCarrito = document.getElementById("totalCarrito");

/* ðŸ’² FORMATO SIN CENTAVOS Y CON MILES */
function formatoPesos(valor) {
    return "$" + Number(valor).toLocaleString("es-AR");
}

function cargarCarrito() {
    fetch("/vendedor/api/carrito")
    .then(r => r.json())
    .then(data => {
        carrito.innerHTML = "";

        data.items.forEach(i => {
            carrito.innerHTML += `
                <li style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <span>
                        ${i.nombre} x${i.cantidad}<br>
                        <small>${formatoPesos(i.subtotal)}</small>
                    </span>
                    <button
                        onclick="eliminar(${i.id})"
                        style="background:#dc2626; color:white; border:none; border-radius:6px; padding:4px 8px;">
                        âˆ’
                    </button>
                </li>
            `;
        });

        totalCarrito.innerText = formatoPesos(data.total);
    });
}

function agregar(id) {
    const input = document.querySelector(`.cantidad[data-id="${id}"]`);
    const cantidad = input.value;

    fetch("/vendedor/api/carrito/agregar", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            producto_id: id,
            cantidad: cantidad
        })
    }).then(() => {
        input.value = 1;
        cargarCarrito();
    });
}

function eliminar(id) {
    fetch(`/vendedor/api/carrito/eliminar/${id}`, {
        method: "POST"
    }).then(() => cargarCarrito());
}

function cobrar() {
    if (!confirm("Â¿Confirmar cobro?")) return;

    fetch("/vendedor/api/carrito/cobrar", {
        method: "POST"
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        alert("Venta realizada con Ã©xito");
        cargarCarrito();
    });
}


/* âŒ¨ï¸ ATAJO POS */
document.addEventListener("keydown", e => {
    if (e.key === "Enter") {
        const visible = document.querySelector(".producto:not([style*='none'])");
        if (visible) {
            agregar(visible.querySelector(".cantidad").dataset.id);
        }
    }
});

cargarCarrito();

/* ===== FILTROS EN VIVO ===== */
const buscador = document.getElementById("buscador");
const proveedorFiltro = document.getElementById("proveedorFiltro");
const precioMax = document.getElementById("precioMax");

function filtrarProductos() {
    const texto = buscador.value.toLowerCase();
    const proveedor = proveedorFiltro.value;
    const precio = Number(precioMax.value || 0);

    document.querySelectorAll(".producto").forEach(prod => {
        const nombre = prod.dataset.nombre;
        const provId = prod.dataset.proveedor;
        const precioProd = Number(prod.dataset.precio);

        let visible = true;

        /* ðŸ” Buscar por nombre */
        if (texto && !nombre.includes(texto)) {
            visible = false;
        }

        /* ðŸ­ Filtro proveedor */
        if (proveedor && provId !== proveedor) {
            visible = false;
        }

        /* ðŸ’² Precio mÃ¡ximo */
        if (precio && precioProd > precio) {
            visible = false;
        }

        prod.style.display = visible ? "flex" : "none";
    });
}

/* EVENTOS */
buscador.addEventListener("input", filtrarProductos);
proveedorFiltro.addEventListener("change", filtrarProductos);
precioMax.addEventListener("input", filtrarProductos);

</script>



{% endblock %}
