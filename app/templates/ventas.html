{% extends "base.html" %}

{% block title %}Ventas{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ventas.css') }}">
{% endblock %}

{% block content %}

<div class="dashboard">

    <!-- üîπ Sidebar -->
    <div class="sidebar">
        <h2>Ventas Toti</h2>
        <button onclick="openTab('productos')">üõí Productos</button>
        <button onclick="openTab('carrito')">üõçÔ∏è Carrito</button>
        <button onclick="openTab('stock')">üì¶ Stock</button>
        <button onclick="openTab('historial')">üìú Historial</button>
        <button onclick="openTab('estadisticas')">üìà Estad√≠sticas</button>
    </div>

    <!-- üîπ Main Content -->
    <div class="main-content">

        <!-- Productos -->
        <div id="productos" class="tab active">
            <div class="card">
                <h3>Agregar producto</h3>
                <form method="POST" action="/ventas/agregar">
                    <input name="nombre" placeholder="Nombre" required>
                    <input name="precio" placeholder="Precio" type="number" step="1" required>
                    <input name="costo" placeholder="Costo" type="number" step="1" required>
                    <input name="stock" placeholder="Stock" type="number" required>
                    <button type="submit">Guardar</button>
                </form>
            </div>
            <div class="card expanded">
                <h3>Productos disponibles</h3>
                <div class="card-content">
                    {% for p in productos %}
                    <div class="producto">
                        {{ p.nombre }} - {{ p.precio | ars }}
                        <a href="/ventas/carrito/agregar/{{ p.id }}" class="btn-agregar">Agregar</a>
                        <a href="/ventas/carrito/quitar/{{ p.id }}" class="btn-quitar">Quitar</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="card">
                <h3>Vender producto</h3>
                {% for p in productos %}
                <form method="POST" action="/ventas/vender/{{ p.id }}" class="producto-form">
                    <span>{{ p.nombre }} - {{ p.precio | ars }} - stock: {{ p.stock }}</span>
                    <select name="cliente_id">
                        <option value="">Consumidor final</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nombre }}</option>
                        {% endfor %}
                    </select>
                    <select name="metodo_pago">
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="fiado">Fiado</option>
                    </select>
                    <input type="number" name="cantidad" value="1" min="1" max="{{ p.stock }}">
                    <button type="submit">Vender</button>
                </form>
                {% endfor %}
            </div>
        </div>


        <!-- Carrito -->
        <div id="carrito" class="tab">
            <div class="card">
                <h3>Carrito</h3>
                {% if carrito.detalles %}
                    {% for d in carrito.detalles %}
                    <div class="producto">{{ d.nombre_producto }} x {{ d.cantidad }} = {{ d.subtotal | ars }}</div>
                    {% endfor %}
                    <strong>Total: {{ carrito.total | ars }}</strong>

                    {% if carrito.estado != "finalizada" %}
                        <form method="POST" action="/ventas/carrito/confirmar">
                            <select name="cliente_id">
                                <option value="">Consumidor final</option>
                                {% for c in clientes %}
                                <option value="{{ c.id }}">{{ c.nombre }}</option>
                                {% endfor %}
                            </select>

                            <select name="metodo_pago">
                                <option value="efectivo">Efectivo</option>
                                <option value="transferencia">Transferencia</option>
                                <option value="fiado">Fiado</option>
                            </select>

                            <button type="submit">Confirmar venta</button>
                        </form>
                    {% endif %}

                    {% if carrito.estado == "finalizada" %}
                    <br>
                    <a href="{{ url_for('ventas.generar_ticket_pdf', id=carrito.id) }}" target="_blank">Generar Ticket PDF</a>
                    {% endif %}
                {% else %}
                <p>No hay productos en el carrito.</p>
                {% endif %}
            </div>
        </div>

        <!-- Stock -->
        <div id="stock" class="tab">
            <div class="card">
                <h3>Control de Stock</h3>
                {% if productos %}
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Stock</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in productos %}
                        <tr>
                            <td>{{ p.nombre }}</td>
                            <td>{{ p.stock }}</td>
                            <td>
                                {% if p.stock == 0 %}
                                    <span class="stock-agotado">Agotado</span>
                                {% elif p.stock <= 5 %}
                                    <span class="stock-bajo">Bajo</span>
                                {% else %}
                                    <span class="stock-suficiente">Suficiente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No hay productos cargados.</p>
                {% endif %}
            </div>
        </div>

        <!-- Historial -->
        <div id="historial" class="tab">
            <div class="card">
                <h3>Historial de Stock</h3>
                {% if movimientos_stock %}
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for m in movimientos_stock %}
                        <tr>
                            <td>{{ m.producto.nombre }}</td>
                            <td>{{ m.cantidad }}</td>
                            <td>{{ m.tipo }}</td>
                            <td>{{ m.fecha.strftime("%d/%m/%Y %H:%M") }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No hay movimientos de stock.</p>
                {% endif %}
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div id="estadisticas" class="tab">
            <div class="card">
                <h3>üìà Estad√≠sticas</h3>
                <div class="stats">
                    <div class="stat-box">
                        <h4>Producto m√°s vendido</h4>
                        {% if producto_mas_vendido %}
                        <p>{{ producto_mas_vendido[0] }} - {{ producto_mas_vendido[1] }} unidades</p>
                        {% endif %}
                    </div>
                    <div class="stat-box">
                        <h4>Ganancia total</h4>
                        <p>{{ ganancia_total | ars }}</p>
                    </div>
                </div>
                <h4>Ventas por m√©todo de pago</h4>
                <ul>
                {% for metodo, stats in estadisticas_metodo.items() %}
                    <li>{{ metodo }}: {{ stats.cantidad_ventas }} ventas, Total: {{ stats.total_recaudado | ars }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>

    </div>

</div>

<script>
// üîπ Tabs
function openTab(tabId) {
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.getElementById(tabId).classList.add("active");
}
</script>

{% endblock %}